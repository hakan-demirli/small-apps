#!/usr/bin/env bash
set -euo pipefail

if [[ -z ${1-} ]]; then
  echo "Usage: $0 <path-to-nix-store-path-or-symlink>"
  echo "Example: $0 ./result"
  exit 1
fi
INPUT_PATH="$1"

DEPS_SCRIPT="@depsScript@"
VIEWER_HTML="@viewerHtml@"
JQ_BIN="@jq@"

TEMP_DIR=$(mktemp -d -t nix-treemap-XXXXXX)
trap 'rm -rf "$TEMP_DIR"' EXIT

JSON_OUTPUT="$TEMP_DIR/graph.json"
FINAL_HTML_OUTPUT="$TEMP_DIR/final-treemap.html"

echo "Generating dependency graph for '$INPUT_PATH'..."
"$DEPS_SCRIPT" "$INPUT_PATH" "$JSON_OUTPUT"
if [ ! -s "$JSON_OUTPUT" ]; then
  echo "FATAL: Failed to generate dependency graph JSON."
  exit 1
fi

echo "Embedding data into HTML viewer..."

# Minify JSON to a temporary file
JSON_MIN="$TEMP_DIR/graph.min.json"
"$JQ_BIN" -c . "$JSON_OUTPUT" > "$JSON_MIN"

# Use awk to inject the JSON content into the HTML template to avoid "Argument list too long"
awk -v json_file="$JSON_MIN" '
  {
    if (match($0, /null; \/\* JSON_PLACEHOLDER \*\//)) {
      # Print part before match
      printf "%s", substr($0, 1, RSTART - 1)

      # Print file content
      while ((getline line < json_file) > 0) {
        printf "%s", line
      }
      close(json_file)

      # Print part after match
      print substr($0, RSTART + RLENGTH)
    } else {
      print
    }
  }
' "$VIEWER_HTML" > "$FINAL_HTML_OUTPUT"

echo "Opening visualization in browser: $FINAL_HTML_OUTPUT"
xdg-open "$FINAL_HTML_OUTPUT" &> /dev/null || open "$FINAL_HTML_OUTPUT" &> /dev/null || start "" "$FINAL_HTML_OUTPUT" &> /dev/null || {
  echo "--------------------------------------------------"
  echo "Could not automatically open your web browser."
  echo "Please open this file manually:"
  echo "$FINAL_HTML_OUTPUT"
  echo "--------------------------------------------------"
  trap - EXIT
}

sleep 3
